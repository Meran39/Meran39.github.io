# コード解説：仮想住民シミュレーション

このドキュメントは、仮想住民シミュレーションプロジェクトの各開発フェーズにおけるコードの設計思想と主要な実装について解説します。

## フェーズ 1：LLM 単一エージェント呼び出し

### 目標

シミュレーションの最小構成単位として、単一のエージェントが大規模言語モデル（LLM）と通信し、自律的な行動を生成する基盤を構築すること。

### 主要なコードと解説

- **`src/models/Agent.ts`**:

  - エージェントの基本となるクラスを定義。
  - `id`: エージェントを一意に識別するための識別子。
  - `memory`: エージェントの記憶を保持する領域。この段階ではシンプルな文字列配列などを想定。

- **`src/services/llm.ts`**:

  - Hugging Face Inference API などの LLM サービスと通信するためのラッパークラス `LLMService` を実装。
  - API キーなどの認証情報を安全に管理し、外部 API へのリクエストを抽象化する責任を持つ。
  - `generateAction(prompt: string): Promise<string>` のようなメソッドを提供し、プロンプトを渡すと LLM が生成した行動（テキスト）を返す。

- **`prompts/creativePrompts.json`**:

  - LLM に与えるプロンプトのテンプレートを管理。
  - システムメッセージとユーザーメッセージの構造を定義し、エージェントの役割、性格、状況などを動的に埋め込めるように設計。
  - 例：「あなたは[性格]な住民です。現在の状況は[状況]です。次は何をしますか？」

- **`src/App.tsx` (初期実装)**:
  - 単一のエージェントインスタンスを生成。
  - `LLMService` を利用してエージェントの行動を非同期に取得し、その結果を画面に表示する。
  - このフェーズでの UI は、動作確認のための最小限のもの。

## フェーズ 2：複数エージェントの導入と相互作用

### 目標

シミュレーションに複数のエージェントを登場させ、エージェント同士が互いを認識し、基本的な相互作用を行えるようにすること。

### 主要なコードと解説

- **`src/App.tsx` / `src/components/ControlPanel.tsx`**:

  - シミュレーションの実行を管理するロジックを実装。
  - 「ステップ実行」ボタンなどを設け、1 ステップごとに各エージェントが行動するように制御する。
  - エージェントのリストを保持し、ループ処理で各エージェントの `update` メソッドなどを呼び出す。

- **エージェント間の相互作用**:
  - エージェントの行動選択肢に「他のエージェントと話す」などを追加。
  - LLM へのプロンプトに、周囲にいる他のエージェントの情報を含めることで、LLM が他者を認識した行動を生成できるようにする。
  - 例：「あなたの周りには[エージェント B の名前]がいます。何をしますか？」

## フェーズ 3：環境との相互作用と状態変化

### 目標

エージェントが単に存在するだけでなく、時間や場所の概念を持ち、環境内のオブジェクトと相互作用することで、その状態が変化する仕組みを導入すること。

### 主要なコードと解説

- **`src/types/index.ts`**:

  - `Environment` や `Location` といった新しい型を定義。
  - 場所（例：家、公園）や、そこにあるオブジェクト（例：PC, ベッド）をデータ構造として表現。

- **`Agent.ts` の拡張**:

  - `currentLocation`: エージェントの現在地を示すプロパティを追加。
  - `status`: 幸福度、空腹度、所持金などのエージェントの状態を表すオブジェクトを追加。

- **行動決定ロジックの高度化**:
  - LLM へのプロンプトに、現在の場所とそこにあるオブジェクトの情報を含める。
  - LLM が生成した行動（例：「PC で仕事をする」）に応じて、エージェントの `status`（所持金が増える、など）を変化させるロジックを実装。

## フェーズ 4：記憶と学習

### 目標

エージェントに長期的な記憶を持たせ、過去の経験に基づいて行動が変化する、より人間らしい学習能力を実装すること。

### 主要なコードと解説

- **`src/services/memoryManager.ts`**:

  - エージェントの記憶を管理する専門のサービス。
  - **記憶の追加**: 新しい出来事（例：「A さんと公園で話した」）を記憶として保存する。
  - **記憶の検索**: 現在の状況に関連する過去の記憶を検索し、LLM のプロンプトに含めるための機能。ベクトル検索などを利用して関連性の高い記憶を効率的に見つけ出す。
  - **忘却**: 時間の経過や重要度の低さに応じて、古い記憶を忘れるメカニズムを実装し、記憶の無限増殖を防ぐ。

- **`Agent.ts` との連携**:
  - エージェントの `memory` プロパティを、単なる配列から `memoryManager` を利用する構造に変更。
  - 行動決定のたびに `memoryManager` から関連記憶を取得し、意思決定の質を高める。

## フェーズ 5：目標と計画の立案

### 目標

エージェントが場当たり的な行動だけでなく、長期的な目標を持ち、それを達成するための計画を自律的に立てて実行できるようにすること。

### 主要なコードと解説

- **`src/services/decisionManager.ts`**:

  - エージェントの意思決定プロセスを統括するサービス。
  - **目標設定**: エージェントに「プログラマーになる」「資産を築く」などの長期目標を設定する。
  - **計画立案**: 長期目標を達成するために、LLM を利用して「今日はプログラミングを 3 時間勉強する」といった短期的な計画（タスク）を生成させる。
  - **計画の評価と修正**: 計画の進捗を監視し、予期せぬ出来事があった場合に計画を動的に修正するロジック。

- **プロンプトの階層化**:
  - 「長期目標」→「今日の計画」→「現在の行動」のように、プロンプトを階層的に設計し、LLM が一貫性のある行動を生成できるように誘導する。

## フェーズ 6：経済システムの導入

### 目標

シミュレーション内に職業、収入、消費といった基本的な経済活動を導入し、エージェントの生活にリアリティを与えること。

### 主要なコードと解説

- **`src/services/costOptimizer.ts` (役割拡大)**:

  - 当初は LLM コスト最適化を想定していたが、シミュレーション内の経済活動を管理するサービスとして役割を拡大。
  - **職業と給与**: エージェントに職業を割り当て、労働時間に応じて給与を支払う。
  - **消費活動**: エージェントが食料や娯楽などのためにお金を使う行動を管理。所持金が不足している場合は、行動を制限する。

- **経済モデル**:
  - グローバルな状態として、市場に存在する商品やサービスの価格を管理。
  - 将来的には、需要と供給に応じて価格が変動するような、より動的なモデルも検討。

## フェーズ 7：社会システムの導入とルールの適用

### 目標

友人関係やコミュニティといった社会的な構造を導入し、エージェントが従うべき社会規範やルールを定義することで、より複雑で秩序ある社会をシミュレートすること。

### 主要なコードと解説

- **`src/services/ruleEngine.ts`**:

  - シミュレーション世界の物理法則や社会ルールを定義・管理するエンジン。
  - 例：「夜 10 時以降は騒音を出してはいけない」「他人の家に勝手に入ってはいけない」といったルールを定義。
  - エージェントの行動がルールに違反していないかをチェックし、違反した場合はペナルティ（評判の低下など）を与える。

- **`Agent.ts` の関係性プロパティ**:

  - `relationships`: 他のエージェントとの関係性（友人、知人、敵対など）と、その親密度を記録するデータ構造を追加。
  - 相互作用の結果に応じて、この関係性が変化するようにする。

- **コミュニティ形成**:
  - 共通の興味や活動を持つエージェントたちが自然とグループを形成し、独自の文化やルールを生み出すような、創発的な振る舞いを観察する。

## フェーズ 8：シミュレーションの長期運用と可視化

### 目標

シミュレーションを安定して長期間（週次・月次）実行できるアーキテクチャを構築し、その複雑な結果を人間が直感的に理解できるよう可視化すること。

### 主要なコードと解説

- **長期運用アーキテクチャ**:

  - データベース（例: Firebase, Supabase）を導入し、エージェントの状態や世界の歴史を永続化する。
  - サーバーレス関数（例: Cloudflare Workers, Vercel Functions）を利用して、定期的にシミュレーションを更新するバッチ処理を実装（Cron ジョブ）。

- **`src/components/AgentVisualization.tsx`**:

  - D3.js を利用し、エージェント、場所、ゾンビの位置や動きを 2D で視覚的に表示する。
  - エージェント間の関係性をネットワーク図として表示する機能は今後の拡張。

- **`src/components/SimulationLogs.tsx`**:

  - シミュレーションで発生したすべてのイベント（行動、会話、状態変化）を時系列で表示するログ機能。
  - 特定のエージェントやイベントでフィルタリングできる、高度な検索機能を提供。

- **ユーザー介入機能**:
  - `ControlPanel.tsx` を拡張し、ユーザーがシミュレーションの世界に介入できる機能を追加。
  - 例：新しいエージェントの投入、災害の発生、経済政策の実施など。

### ゾンビシミュレーションのプロトタイプ実装

- `Zombie` インターフェースを定義 (`src/types/index.ts`)。
- `App.tsx` にゾンビの状態管理を追加。
- マップ内でのゾンビ出現ロジックを実装 (`src/App.tsx`)。
- `AgentVisualization.tsx` にゾンビの描画ロジックを追加し、視認性を向上。
- ゾンビが最も近いエージェントまたは拠点に向かって移動するロジックを実装 (`src/App.tsx`)。
- ゾンビとエージェント、ゾンビと拠点の衝突判定とダメージ処理を実装 (`src/App.tsx`)。
- エージェントに武器を持たせる機能を追加 (`src/types/index.ts`, `src/models/Agent.ts`, `src/App.tsx`)。
- 武器の視覚化を実装 (`src/components/AgentVisualization.tsx`)。
- エージェントの連続的な移動を実装 (`src/models/Agent.ts`, `src/App.tsx`)。
- 拠点の体力と破壊を実装 (`src/types/index.ts`, `src/App.tsx`)。
- エージェントの死亡と除去の最終化を実装 (`src/App.tsx`)。
- 物資調達システムの実装 (金銭による購入ロジックをコメントアウト) (`src/App.tsx`, `src/models/Agent.ts`)。

### 最近のデバッグと改善 (2025 年 7 月 25 日)

- `App.tsx`における`toggleRunning`および`resetSimulation`関数の重複定義を解消。
- `decisionManager.ts`内の`moveRegex`を修正し、LLM からの`targetLocation`のパース精度を向上。
- `App.tsx`のゾンビ生成位置をマップの表示範囲内に調整。
- `AgentVisualization.tsx`にてゾンビの描画設定（サイズ、色）を一時的に変更し、視認性を向上。
- `App.tsx`にゾンビの生成座標と`zombies`配列の内容をログ出力するデバッグコードを追加。
- ゾンビの初期体力を`100`から`500`に増加させ、マップ上での生存時間を延長。
- `App.tsx`におけるゾンビの移動とダメージ処理のロジックを調整し、ゾンビが生成直後に消滅する問題を修正。
- `App.tsx`のゾンビ移動ロジックにおける`prevZombies`の参照エラーを修正。

## プロトタイプとして機能するまでに残っていること

1.  **LLM プロンプトのゾンビシミュレーションへの調整 (進行中):** エージェントがゾンビの脅威を認識し、それに応じた行動（逃走、戦闘、物資調達の優先など）を取るように、LLM へのプロンプトを調整中。エネルギー値とムードの形式改善、移動先指定の強化を試みています。
2.  **マップの視覚的改善 (完了):** 日本の都市（札幌駅周辺）をモデルにしたマップの背景画像とアイコンを実装しました。
3.  **他生存者とのインタラクション:** 友好的、中立、敵対的な生存者との物資のやり取りや戦闘などのインタラクションを実装します。
